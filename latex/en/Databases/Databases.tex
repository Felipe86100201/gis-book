\chapter{Bases de datos}

\pagestyle{fancy}

Databases are used in all disciplines in which an efficient data handling is needed, specially if those data are large. The data that is used in GIS are usually rather large, and the improvements in data acquisition have caused geogrpahical data to be now more precise and, consequiently, larger. 

Databases not only have the advantage of being able to work with large datasets, but also otrhe ones such as managing multiple users or providing efficient access and indexing. For this reasons, they are a fundamental element in any software context, including GIS.

A \textbf{Database} is a \textbf{organized and sistematically stored collection of data}. Databases provide a better way of handling and using data, thanks to their structure.

Some of the advantages of using a database instead of a tradicional file-based approach for storing data are:

\begin{itemize}
	\item \textbf{More independence}. Data are independent from both the users and the software.
	\item \textbf{More availability}. Databases facilitate the access to data from different context and applications, making them more useful for a larger number of users.
	\item \textbf{More security (data protection)}. Replication and synchronization of data becomes easier.
	\item \textbf{Less redundancy}. Which implies a smaller volume of data and faster access.
	\item \textbf{More efficiency in data capture, encoding and input}}.
\end{itemize}

This has a direct influence in the results that are obtained from the explotation of database data, and we find the following advantages:

\begin{itemize}
	\item \textbf{More coherence}. Better management leads to better data, and that produces results with a better quality.
	\item \textbf{More efficiency}. Accesing the data is easier and more effective.
	\item \textbf{More informative value}. It is easier to extract the information that is contained in the data, since one of the goals of a database is the increse the value of data as source of information.
\end{itemize}

Users also get advantages when using a database, such as the following ones:

\begin{itemize}
	\item \textbf{Easier access}. The user of the database just has to worry about \emph{using} the data. A solid infrastructure to do it is available, and so are the tools needed for it.
	\item \textbf{Easier data reutilization}. Data is easier to share when using a database.
\end{itemize}

In short, we can say that the main characteristic of a database is the \textbf{centralization} of data that it implies, which results in a \textbf{better data access, management and organization}.


\section{Relational databases}

From the many different models that have been defined for creating a database, the most popular one, both in the GIS context and outside of it, is the one used in databases known as \textbf{relational databases}. This model uses a scheme based on \textbf{tables}, which is both easy to understand and to use for analysis and data queries. Tales have a certain number of \textbf{records} (rows) and \textbf{fields} (columns).

The table itself is knows as a \textbf{relation}, since it contains the relation that exists between its elements. Columns represent the \textbf{attributes} associated to a feature, while rows contain the \textbf{records}. A row is formed with a set of $n$ attributes, which form a \textbf{tuple}.

A databse usually contains more than a table, since the information to store is of many different types, and it is convenient to separate it into several tables. Apart from the relations that the table itself implies, relations between tables can also be defined. In this case, we need to have some attribute that can be used to unequivocally represent a tuple. This attribute is known as a \textbf{key attribute}, and it must be \textbf{unique and invariable} for each tuple. For instance, if we have a table where each row represents a person, an attribute containing the Social Security can be used as a key attribute.

When working with geographical data, it is common to use \textbf{the spatial component as key}, since it is usually unique.


Relations between tables can be of several types, depending on the records of one table that are related with the ones of the other table. We have \textbf{one to one}, \textbf{one to many} and \textbf{many to many} relations. for instance, if we have a table with cities and another one with persons, and we define a relation \emph{lives in}, it will be a one to many relation, since many people can live in a a single city, and each person lives in only one of them.


\section{Database management systems}

Along with databases, the fundamental element to exploit them are \textbf{database management systems} (DBMS). These systems are an \txtbf{intermediary element between the data and the sofware that consumes them}. Software such as a desktop GIS does not access the database directly, but instead \textbf{through a DBMS}.

The following are some of the characteristics that a DBMS must have:

\begin{itemize}
	\item \textbf{Acceso transparente a los datos}. El SGBD debe crear una abstracción de los datos que haga el trabajo con estos más sencillo, ocultando aspectos internos que no sean relevantes para dicho trabajo.
	
	Procedimientos como las \textbf{consultas} se realizan a través del SGBD, que es quien se encarga de interpretar dichas consultas, aplicarlas sobre la base de datos y devolver el resultado correspondiente. El SIG no accede a los datos, sino que se comunica con el SGBD y deja en manos de este el proceso de consulta en sí.
	\item \textbf{Protección de los datos}. Si la base de datos almacena información sensible, el SGBD debe \textbf{controlar el acceso} a esta, restringiendo el acceso cuando corresponda (por ejemplo, estableciendo distintos permisos de acceso para distintos tipos de usuarios) e implementando los mecanismos de protección necesarios.
	\item \textbf{Eficiencia}. El SGBD debe ser capaz de gestionar de forma fluida \textbf{grandes volúmenes de datos o de operaciones} (por ejemplo, muchos usuarios accediendo simultáneamente), de modo que dé una respuesta rápida a las peticiones de los usuarios de la base de datos.
	\item \textbf{Gestión de transacciones}. Las operaciones sobre la base de datos tales como la adición o borrado de un registro se realizan mediante transacciones. El SGBD ha de encargarse de gestionarlas de manera eficiente y segura para que todos los usuarios de la base de datos puedan hacer su trabajo de forma transparente. Se denomina \textbf{transaccional} al SGBD capaz de garantizar la integridad de los datos, no permitiendo que las transacciones puedan quedar en un estado intermedio. 

\end{itemize}

En este sentido, resulta de especial importancia la existencia de \textbf{lenguajes de consulta}, que son los que una aplicación utilizará para comunicarse con el SGBD y expresar las operaciones que desea realizar con los datos de la base de datos. El lenguaje de consulta mas extendido es \textbf{SQL} (Standard Query Language)

\subsection{Bases de datos espaciales}

Todo cuanto hemos visto en los puntos anteriores constituye el conjunto de ideas fundamentales sobre las que se asienta la creación y uso de bases de datos de cualquier índole. La inclusión de datos espaciales en este esquema no es en absoluto obvia, y presenta una complejidad adicional que requiere de nuevos planteamientos. Para que una base de datos pueda considerarse espacial, debe adaptarse y añadir elementos adicionales. 

En primer lugar, el dato espacial debe poder \textbf{almacenarse de forma nativa} en la base de datos. Esto quiere decir que una geometría debe poder almacenarse asociada a una entidad en una tabla, del mismo modo que sucede con otros tipos de datos tales como valores numéricos o cadenas de texto. El dato no solo debe poder almacenarse, sino también \textbf{entenderse} por parte del SGBD, para así comprender su naturaleza espacial y poder responder a peticiones relativas a esta por parte del usuario. Esto se denomina \textbf{almacenamiento transparente}, frente al almacenamiento \textbf{opaco}, en el cual la base de datos es capaz de recoger cualquier tipo de valor, pero sin ser capaz de entender su naturaleza y utilizarlo.

Aunque existen planteamientos para almacenar datos ráster en bases de datos, \textbf{las bases de datos espaciales trabajan principalmente con datos vectoriales} y están mejor adaptadas a estos. Las geometrías del dato vectorial se incluyen, como ya se ha dicho, dentro de los valores de un registro de la tabla (que se corresponde con una entidad en el modelo de datos vectoriales). Por su parte, la componente temática del dato espacial puede almacenarse sin problema en la base de datos, sin necesidad de ningún tipo de adaptación.

Cuando la base de datos está preparada para almacenar y trabajar con los datos espaciales, es necesario \textbf{adaptar el lenguaje de consulta}. A las operaciones habituales que un SGBD es capaz de realizar en función de los datos, se añaden otras que utilizan las propiedades espaciales del dato espacial. Se tiene así un \textbf{lenguaje de consulta espacial}, que permite consultas con componente espacial.


\section{Consultas}


Entendemos por consulta una operación en la cual \emph{preguntamos} a los datos geográficos algún tipo de cuestión simple, generalmente basada en conceptos formales sencillos. Este tipo de análisis, aunque no implica el uso de conceptos analíticos complejos, es uno de los elementos clave de los SIG, pues es parte básica del empleo diario de estos.

Aunque las consultas no son algo exclusivo de las bases de datos, es mediante el concurso de estas que adquieren toda su potencia y permite efectuar gran parte de las operaciones habituales de un SIG.

En el contexto espacial, una consulta representa un uso similar al que damos a un mapa clásico, cuando en base a este respondemos a preguntas como \emph{¿qué hay en la localización X?} o \emph{¿qué ríos pasan por la provincia Y?} No obstante, no debemos olvidar que los datos espaciales tienen dos componentes: una espacial y otra temática. Preguntas como las anteriores hacen referencia a la componente espacial, pero igualmente pueden efectuarse consultas que se apliquen sobre la parte temática. Y más aún, pueden efectuarse consultas conjuntas que interroguen a los datos geográficos acerca de los atributos espaciales y temáticos que estos contienen.


Un ejemplo muy sencillo de consulta es lo que conocemos en un SIG como \textbf{selección}. De todos los registros de la tabla de datos, aquellos que cumplen el criterio indicado se marcan como seleccionados, y posteriormente pueden utilizarse únicamente estos como base de otro análisis, o simplemente el usuario puede ver cuáles han sido los seleccionados para así obtener la respuesta a su consulta. La figura \ref{Fig:Seleccion} muestra un ejemplo típico de esto, en el que el usuario define un área rectangular y se seleccionan las entidades que cumplen la condición de intersecar con él. Los criterios de selección pueden ser sencillos como este, o más elaborados y complejos.

\begin{figure}[!hbt]   
\centering
\includegraphics[width=\textwidth]{../es/Bases_datos/Seleccion_rectangulo.png}
\caption{\small Una consulta sencilla mediante la definición gráfica de un rectángulo. Todas las entidades dentro de este son el resultado de la consulta y quedan seleccionadas en el SIG.}
\label{Fig:Seleccion} 
\end{figure}


Una consulta nos vale también para extraer información de una base de datos de acuerdo a nuestras necesidades, y para crear posteriormente y a partir de dicha información una nueva capa. Esta operación es útil cuando la base de datos de la que disponemos es muy voluminosa y solo resulta de interés para nuestro trabajo una parte de ella. Puede tratarse de una parte en el sentido espacial (la base de datos contiene datos a nivel mundial y se quiere trabajar a nivel estatal), en el sentido temático (la base de datos contiene mucha información de cada entidad y solo interesan algunos campos), o en una combinación de ambas. Para extraer dicha parte y trabajar únicamente con ella, utilizaremos una consulta.

Veamos algunos ejemplos de consultas. Sea  una capa con los distintos países del mundo y una serie de valores económicos y sociales asociados a cada uno de ellos. Consideremos las siguientes preguntas:

\begin{itemize}
 \item ¿Qué países tienen un Producto Interior Bruto mayor que el de España?
\item ¿Qué países han experimentado un crecimiento económico en el último año?
\item ¿Cuántos países tienen más de 200 millones de habitantes? 
\end{itemize}

En todos estos casos estamos haciendo referencia a países, los cuales, como sabemos, estarán asociados a elementos geométricos que definan sus propiedades espaciales, es decir, a una componente espacial. Esta componente es la que permite que, además de poder plantear las consultas anteriores, podamos representar cada país en la pantalla y visualizarlo, o saber cuáles de ellos se encuentran en el hemisferio norte (esta sería una consulta espacial, de las que más adelante en este mismo capítulo veremos).

Sin embargo, cuando realizamos consultas como las tres anteriores, no acudimos para nada a la componente espacial. Consultas como estas podrían resolverse si en lugar de una capa dentro de un SIG tuviéramos, por ejemplo, un simple anuario estadístico lleno de tablas con datos correspondientes a cada país. 

Las consultas pueden incluir varios criterios en una sola pregunta. Por ejemplo:

\begin{itemize}
 \item ¿Qué países de la zona euro tienen más de 40 millones de habitantes?
\item ¿En qué países de habla inglesa aumentó la población durante el último año?
\end{itemize}

Para expresar esas consultas se han de incluir elementos de la denominada \textbf{lógica booleana}. Esta implica el uso de \textbf{operadores lógicos}, mediante los cuales se reescribirían las consultas anteriores de la siguiente manera:

\begin{itemize}
 \item ¿Qué países tienen como moneda el euro \emph{y} a la vez tienen más de 40 millones de habitantes?
\item ¿Que países hablan inglés \emph{y} sufrieron un aumento de población durante el último año?
\end{itemize}

Los lenguajes de consulta que se emplean para transmitir estas operaciones a un SGBD, permiten el uso de tales operadores para formular consultas.

Si el SGBD es de tipo espacial y \emph{entiende} que algunas de las columnas de una tabla contiene información espacial (es decir, que cada entidad no solo tiene información temática), pueden plantearse consultas que hacen uso de esta, tales como las siguientes.

\begin{itemize}
\item ¿Qué países comparten frontera con Alemania?
\item ¿Cuántos países se encuentran completamente en el hemisferio sur?
\item ¿Qué países están a menos de 2000 km de España?
\end{itemize}

Para dar respuesta a esas cuestiones, basta analizar la componente espacial y no necesitamos para nada los datos con los que hemos trabajado anteriormente. Son consultas puramente espaciales. Aunque estas consultas amplían lo que ya conocemos, en realidad no abren ninguna nueva vía de estudio de los datos geográficos. Son consultas a las que podríamos responder utilizando un mero mapa impreso, sin aprovechar el hecho de que dentro de un SIG las componentes espacial y temática se hallan íntimamente vinculadas. La verdadera potencia de las consultas espaciales la encontramos en la combinación de estas consultas sobre la componente espacial y las que vimos anteriormente sobre la componente temática. Así, se pueden plantear, por ejemplo, cuestiones como:

\begin{itemize}
 \item ¿Qué países del hemisferio norte tiene una densidad de población mayor que la de Perú?
\item ¿Cuántos países con más de 10 millones de habitantes se encuentran a menos de 1000 km de la frontera de Rusia?
\end{itemize}

Estas consultas incorporan elementos que hacen necesario acudir a la tabla de atributos, y otros que requieren analizar la componente espacial, estudiando las relaciones espaciales y topológicas de las geometrías asociadas. 

Las consultas pueden incluir \textbf{varias capas}. Por ejemplo, si ademas de la capa de países disponemos de una capa de ríos del mundo, podríamos responder a la pregunta \emph{¿qué países atraviesa el Nilo?}


Igualmente, las uniones entre tablas que hemos visto para el caso de la componente temática pueden establecerse mediante un criterio espacial. Se tiene así una \textbf{unión espacial}.

Un ejemplo muy sencillo de unión espacial es el que encontramos si combinamos la capa de países del mundo que venimos utilizando con una capa de ciudades del mundo. Podemos unir a la tabla de esta segunda capa todos los valores que caracterizan al país al que pertenece cada ciudad. Si existe un campo común entre ambas tablas de atributos (por ejemplo, el nombre del país), esto serviría para efectuar esta unión. No obstante, esto no es necesario, ya que existe otro elemento común que no se encuentra almacenado dentro de la tabla, pero que puede tomarse de la componente espacial: toda ciudad debe estar situada dentro de los límites del país al que pertenece. Esto sirve para establecer la relación entre las tablas, y cada ciudad debe relacionarse con aquella entidad dentro de cuya geometría se encuentre el punto que la representa.



\subsection{Índices espaciales}


Si realizamos una consulta a una base de datos, el resultado es un subconjunto de esta con los elementos que cumplen el criterio expresado en la consulta. Si se implementa de forma \emph{directa} dicha consulta, esta operación implica comprobar todos los elementos de la base de datos y ver cuáles son los que cumplen con el citado criterio. Teniendo en cuenta que una base de datos puede tener un gran tamaño, esta forma de proceder no es la óptima.

Los índices nos permiten \emph{alcanzar} los elementos que constituyen la respuesta a nuestra consulta, haciéndolo de la forma más rápida y llegando hasta ellos sin tener que pasar por todos los restantes.

Un ejemplo fácil de entender es el de una guía telefónica en la que los nombre están ordenados alfabéticamente. Gracias a ese orden y a que se conoce el alfabeto, se puede buscar rápidamente un nombre sin necesidad de leer todos ellos.

Al utilizar una base de datos, si no disponemos de un índice deberemos recorrer toda ella para dar respuesta a nuestras consultas. No sabemos \emph{dónde} buscar las respuestas a nuestras consultas, del mismo modo que si no supiéramos que carece de sentido buscar en la letra F el número telefónico del señor Pérez.

Ademas de índices para datos de tipo numérico o texto, en los que resulta obvio establecer un orden natural, en el ámbito de los SIG tienen importancia los denominados \textbf{índices espaciales}. Aunque sus fundamentos teóricos son distintos, el concepto es similar al de índices de bases de datos no espaciales: elementos que permiten \textbf{optimizar las consultas mediante una correcta estructuración} de los datos, en particular en este caso de su componente espacial.

Puede entenderse la idea de un índice espacial mediante un sencillo ejemplo de cómo empleamos ideas parecidas a los índices espaciales de forma natural cuando tratamos de resolver una consulta espacial sin la ayuda de un SIG. Supongamos que tenemos nuestro mapa de países del mundo y queremos averiguar qué países tienen su frontera a menos de 3000 kilómetros de la frontera de España. ¿Cómo operaríamos de manera natural para dar respuesta a esta consulta?

La solución más inmediata es medir la distancia entre España y todos los países restantes, y después tomar aquellos que hayan arrojado un resultado de distancia menor a 3000. La operación daría el resultado esperado, pero implicaría un gran número de mediciones, y no sería una forma óptima de operar. Más probable es que no efectuemos mediciones con los países de América, pues un conocimiento básico de geografía basta para saber que todos ellos se encuentran a más de 3000 kilómetros. No sabemos exactamente a qué distancia se encuentran, pero sabemos que no van a cumplir el criterio establecido en la consulta. 

Ese conocimiento básico de geografía que tenemos es en realidad una especie de índice espacial. No sirve para saber las distancias exactas ni resolver la consulta por completo, pero sirve para \textbf{dar una aproximación y facilitar el trabajo}. Descartamos un buen numero de países de forma casi inmediata, y luego solo realizamos las operaciones costosas (la medición) con un subconjunto del total. 

De modo similar, los índices espaciales nos permiten obtener resultados en un área concreta sin necesidad de analizar todo el espacio ocupado por el total de los datos. Gracias a ello, hacen las consultas mas efectivas y permiten trabajar con grandes volúmenes de datos.

Los índices espaciales se almacenan junto con los datos a los que hacen referencia, bien en ficheros adicionales o dentro de la propia base de datos, en caso de utilizarse una. Los SGBD espaciales tienen \textbf{capacidades para calcular estos índices espaciales} y almacenarlos en la base de datos, recurriendo a ellos cuando se realiza una consulta que requiera su uso.


\pagestyle{empty}
